name: Auto-Approve All Waiting Workflow Runs

on:
  schedule:
    - cron: '* * * * *'  # Runs every 5 minutes
  workflow_dispatch:
jobs:
  auto-approve:
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.BOT_PAT }}  # Stored in trusted repo
      TARGET_REPO: ossama-ferjani/devops-ci-cd-challenge
      GITHUB_API_URL: https://api.github.com
    steps:
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq
      
      - name: Check and approve all waiting workflow runs
        run: |
          echo "üîç Fetching workflow runs for $TARGET_REPO"
          RESPONSE=$(curl -s -H "Authorization: Bearer $GH_TOKEN" \
            "$GITHUB_API_URL/repos/$TARGET_REPO/actions/runs")
          
          RUNS=$(echo "$RESPONSE" | jq '.workflow_runs[] | select(.status=="waiting") | .id')
          COUNT=$(echo "$RUNS" | grep -v '^$' | wc -l)
          
          echo "üß™ Found $COUNT pending workflow run(s) needing approval."
          
          echo "$RUNS" | while read -r RUN_ID; do
            if [ -n "$RUN_ID" ]; then
              echo "‚úÖ Approving run ID: $RUN_ID"
              curl -s -X POST \
                -H "Authorization: Bearer $GH_TOKEN" \
                -H "Accept: application/vnd.github+json" \
                "$GITHUB_API_URL/repos/$TARGET_REPO/actions/runs/$RUN_ID/approve"
            fi
          done
